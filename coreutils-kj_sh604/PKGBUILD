pkgname=coreutils-kj_sh604
pkgver=9.8
pkgrel=1
pkgdesc='The basic file, shell and text manipulation utilities of the GNU
operating system (with the `arch` binary, managed by kj_sh604)'
arch=('x86_64')
license=(
  GPL-3.0-or-later
  GFDL-1.3-or-later
)
url='https://www.gnu.org/software/coreutils/'
depends=( 
  acl  
  attr
  glibc
  gmp
  libcap
  openssl
)
makedepends=(
  git
  gperf
  python
  wget
)
conflicts=(
    coreutils
    coreutils-arch
)
provides=(
    coreutils
    coreutils-arch
)
source=(
  https://ftp.gnu.org/gnu/coreutils/coreutils-${pkgver}.tar.xz
)
options=(!lto)
b2sums=('a93e26c8dda875b11541808d82ff8d6537f521b9c44e2a9959ee8f452823a4df5aed2793ac32766e2d3f832606d7190f7f53ea5870419f585aa66429a9626d98')

prepare() {
  cd "${pkgname%-kj_sh604}-${pkgver}"
  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    echo "Applying patch $src..."
    patch -Np1 < "../$src"
  done
}

build() {
  cd "${pkgname%-kj_sh604}-${pkgver}"
  ./configure \
    --prefix=/usr \
    --libexecdir=/usr/lib \
    --with-openssl \
    --enable-install-program=arch \
    --enable-no-install-program=hostname,kill,uptime
  make
}

check() {
  cd "${pkgname%-kj_sh604}-${pkgver}"
  make check
}

package() {
  cd "${pkgname%-kj_sh604}-${pkgver}"
  make DESTDIR="${pkgdir}" install
}
